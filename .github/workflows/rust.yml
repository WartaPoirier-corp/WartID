name: Rust

on:
  push:
    branches: [ early-dev, main, ci ]
  pull_request:
    branches: [ early-dev, main, ci ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-server:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
    - uses: Swatinem/rust-cache@v1
    - name: Install diesel
      run: cargo install diesel_cli --no-default-features --features postgres
    - name: Apply migrations
      working-directory: ./wartid-server/
      run: diesel migration run
    - name: Build
      working-directory: ./wartid-server/
      run: cargo +nightly build --verbose
    - name: Run tests
      working-directory: ./wartid-server/
      run: cargo +nighlty test --verbose
